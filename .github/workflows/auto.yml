name: ğŸ¤—ç©ºé—´è‡ªåŠ¨æ„å»º
on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'  # æ¯å¤© 20:00 UTC è§¦å‘

env:
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  USERNAME: ${{ secrets.USERNAME }}
  SPACE_LIST: ${{ secrets.SPACE_LIST }}
  SPACE_TIMEOUT_SECONDS: 600
  GLOBAL_TIMEOUT_SECONDS: 1800

jobs:
  rebuild:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - run: pip install requests pytz

      - id: rebuild
        run: |
          python <<EOF
          import requests, time, os, datetime, logging
          import pytz

          logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

          hf_token = os.environ["HF_TOKEN"]
          username = os.environ["USERNAME"]
          space_list_str = os.environ.get("SPACE_LIST", "")
          space_list = [space.strip() for space in space_list_str.split(",") if space.strip()]
          space_timeout_seconds = int(os.environ.get("SPACE_TIMEOUT_SECONDS", 600))
          global_timeout_seconds = int(os.environ.get("GLOBAL_TIMEOUT_SECONDS", 1800))

          def rebuild_space(space_name, timeout_seconds):
              full_space_name = f"{username}/{space_name}"
              logging.info(f"å¼€å§‹é‡æ–°æ„å»ºç©ºé—´: {full_space_name}")
              rebuild_url = f"https://huggingface.co/api/spaces/{full_space_name}/restart?factory=true"
              status_url = f"https://huggingface.co/api/spaces/{full_space_name}/runtime"

              headers = {"Authorization": f"Bearer {hf_token}", "Content-Type": "application/json"}

              try:
                  response = requests.post(rebuild_url, headers=headers)
                  response.raise_for_status()
                  logging.info(f"âœ…ç©ºé—´{space_name}é‡æ–°æ„å»ºè¯·æ±‚å‘é€æˆåŠŸ")
              except requests.exceptions.RequestException as e:
                  logging.error(f"âŒç©ºé—´{space_name}é‡æ–°æ„å»ºè¯·æ±‚å¤±è´¥: {e}")
                  return False

              start_time = time.time()
              attempt = 0
              max_attempts = 10
              while time.time() - start_time < timeout_seconds and attempt < max_attempts:
                  time.sleep(30)
                  try:
                      status_response = requests.get(status_url, headers=headers)
                      status_response.raise_for_status()
                      status_data = status_response.json()
                      stage = status_data.get("stage", "")
                      logging.info(f"ç©ºé—´{space_name}å½“å‰çŠ¶æ€: {stage}")
                      if stage == "RUNNING":
                          logging.info(f"âœ…ç©ºé—´{space_name}å·²æˆåŠŸé‡æ–°æ„å»º!")
                          return True
                      elif "ERROR" in stage:
                          logging.error(f"âŒç©ºé—´{space_name}æ„å»ºå¤±è´¥: {stage}")
                          return False
                  except requests.exceptions.RequestException as e:
                      logging.error(f"âŒç©ºé—´{space_name}çŠ¶æ€è¯·æ±‚å¤±è´¥: {e}")
                      return False
                  except Exception as e:
                      logging.exception(f"âŒç©ºé—´{space_name}å‘ç”ŸæœªçŸ¥é”™è¯¯: {e}")
                      return False
                  attempt += 1

              logging.warning(f"âš ï¸ç©ºé—´{space_name}æ„å»ºçŠ¶æ€æœªçŸ¥ (è¶…æ—¶æˆ–è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°)")
              return None

          start_time = time.time()
          results = []
          for space in space_list:
              if time.time() - start_time > global_timeout_seconds:
                  logging.warning(f"âš ï¸å…¨å±€è¶…æ—¶ï¼Œå‰©ä½™ç©ºé—´æœªå¤„ç†")
                  break
              result = rebuild_space(space, space_timeout_seconds)
              results.append({"space": space, "result": result})

          summary_plain = f"æ€»è®¡ç©ºé—´æ•°: {len(space_list)}\n"
          summary_plain += f"æˆåŠŸæ•°é‡: {sum(1 for r in results if r['result'] is True)}\n"
          summary_plain += f"å¤±è´¥æ•°é‡: {sum(1 for r in results if r['result'] is False)}\n"
          summary_plain += f"æœªçŸ¥çŠ¶æ€æ•°é‡: {sum(1 for r in results if r['result'] is None)}\n"
          summary_plain += f"{'-'*50}\nå…·ä½“ç»“æœ:\n"
          for r in results:
              status = "âœ…" if r['result'] is True else ("âŒ" if r['result'] is False else "â“")
              summary_plain += f"{status} {r['space']}\n"

          # è¾“å‡ºç»“æœåˆ° GitHub Actions
          print("æ„å»ºç»“æœæ‘˜è¦ï¼š")
          print(summary_plain)

          # è®¾ç½®é€€å‡ºç 
          exit_code = 1 if any(r['result'] is False or r['result'] is None for r in results) else 0

          # å°† exit_code ä¼ é€’ç»™ä¸‹ä¸€æ­¥
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              print(f"exit_code={exit_code}", file=f)

          if exit_code != 0:
              exit(1)
          else:
              exit(0)
          EOF

      - if: always()
        run: exit ${{ steps.rebuild.outputs.exit_code }}

      - if: always()
        run: echo "ğŸæ„å»ºæµç¨‹å·²å®Œæˆ"